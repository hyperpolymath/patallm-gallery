# SPDX-License-Identifier: PMPL-1.0-or-later
name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0, 0.2.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must be in semver format (X.Y.Z)"
            exit 1
          fi

      - name: Check version not already tagged
        run: |
          VERSION="v${{ github.event.inputs.version }}"
          if git tag -l | grep -q "^${VERSION}$"; then
            echo "Error: Tag ${VERSION} already exists"
            exit 1
          fi

      - name: Verify CHANGELOG has entry
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! grep -q "\[${VERSION}\]" CHANGELOG.md; then
            echo "Warning: CHANGELOG.md may not have an entry for version ${VERSION}"
            echo "Ensure the [Unreleased] section is properly documented"
          fi

  test:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

      - name: Build release
        run: cargo build --release

  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Cargo.toml version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml

      - name: Update lib.rs version constants
        run: |
          VERSION="${{ github.event.inputs.version }}"
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          sed -i "s/^pub const VERSION_MAJOR: u32 = .*;/pub const VERSION_MAJOR: u32 = ${MAJOR};/" src/lib.rs
          sed -i "s/^pub const VERSION_MINOR: u32 = .*;/pub const VERSION_MINOR: u32 = ${MINOR};/" src/lib.rs
          sed -i "s/^pub const VERSION_PATCH: u32 = .*;/pub const VERSION_PATCH: u32 = ${PATCH};/" src/lib.rs

      - name: Update CHANGELOG
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Update [Unreleased] to new version with date
          sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [${VERSION}] - ${DATE}/" CHANGELOG.md

          # Update comparison links at bottom
          sed -i "s|\[Unreleased\]: \(.*\)/compare/v.*\.\.\.HEAD|\[Unreleased\]: \1/compare/v${VERSION}...HEAD|" CHANGELOG.md

      - name: Commit version bump
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git add Cargo.toml src/lib.rs CHANGELOG.md
          git commit -m "chore(release): v${VERSION}"

      - name: Create tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git tag -a "v${VERSION}" -m "Release v${VERSION}"

      - name: Push changes
        run: |
          git push origin HEAD
          git push origin --tags

      - name: Extract changelog for release
        id: changelog
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Extract changelog section for this version
          awk "/## \[${VERSION}\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md > release_notes.md
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: v${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: v${{ github.event.inputs.version }}

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable

      - name: Publish to crates.io
        run: cargo publish --dry-run
        # Remove --dry-run and add CARGO_REGISTRY_TOKEN secret to enable publishing
        # env:
        #   CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
