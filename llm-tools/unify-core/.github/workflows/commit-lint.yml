# SPDX-License-Identifier: PMPL-1.0-or-later
name: Commit Lint

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read

jobs:
  lint-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Validate Conventional Commits
        run: |
          # Get commits in this PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking commits from ${BASE_SHA} to ${HEAD_SHA}"

          # Conventional commit regex pattern
          # Format: type(scope)?: description
          # Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
          PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9_-]+\))?: .{1,100}$'

          FAILED=0
          while IFS= read -r commit_msg; do
            # Skip merge commits
            if echo "$commit_msg" | grep -qE '^Merge '; then
              continue
            fi

            # Validate against pattern
            if ! echo "$commit_msg" | grep -qE "$PATTERN"; then
              echo "::error::Invalid commit message: '$commit_msg'"
              echo "  Expected format: type(scope)?: description"
              echo "  Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              FAILED=1
            else
              echo "::notice::Valid: $commit_msg"
            fi
          done < <(git log --format=%s "${BASE_SHA}..${HEAD_SHA}")

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "::error::Some commits do not follow Conventional Commits format."
            echo "See: https://www.conventionalcommits.org/"
            exit 1
          fi

          echo "All commits follow Conventional Commits format!"

      - name: Check commit message length
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          FAILED=0
          while IFS= read -r line; do
            commit_hash=$(echo "$line" | cut -d' ' -f1)
            subject_len=$(git log -1 --format=%s "$commit_hash" | wc -c)
            body_lines=$(git log -1 --format=%b "$commit_hash" | head -1 | wc -c)

            if [ "$subject_len" -gt 100 ]; then
              echo "::warning::Commit $commit_hash has subject > 100 chars ($subject_len)"
            fi

            if [ "$body_lines" -gt 0 ] && [ "$body_lines" -gt 72 ]; then
              echo "::warning::Commit $commit_hash has body line > 72 chars"
            fi
          done < <(git log --format="%H" "${BASE_SHA}..${HEAD_SHA}")
